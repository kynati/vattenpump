<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíß Pump Kontroll</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #1e1e2e;
            --bg-secondary: #2d2d3d;
            --text-primary: #ffffff;
            --accent: #00d4ff;
            --success: #00ff41;
            --danger: #ff0055;
            --warning: #ff9500;
        }
        body.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #000000;
            --accent: #0080ff;
            --success: #00aa00;
            --danger: #ff0000;
            --warning: #ff7700;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 10px;
            transition: background 0.3s;
        }
        .container { max-width: 800px; margin: 0 auto; }
        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid var(--accent);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title { flex: 1; }
        h1 { font-size: 28px; color: var(--accent); margin-bottom: 5px; }
        .mode { font-size: 12px; color: #888888; }
        .theme-toggle { background: var(--accent); color: var(--bg-primary); border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-weight: bold; font-size: 20px; }
        .section { background: var(--bg-secondary); border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--accent); }
        .section h2 { font-size: 16px; margin-bottom: 15px; color: var(--accent); }
        .status-box { background: var(--bg-primary); padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 15px; border: 2px solid var(--danger); }
        .status-box.stopped { color: var(--danger); border-color: var(--danger); }
        .status-box.running { color: var(--success); border-color: var(--success); animation: pump-pulse 1.5s infinite; }
        .status-box.warning { color: var(--warning); border-color: var(--warning); }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }
        .btn-start { background: var(--success); color: #000; }
        .btn-stop { background: var(--danger); color: #fff; }
        .btn-auto { background: var(--accent); color: #000; }
        .btn-auto.active { background: var(--success); }
        input[type="number"], input[type="time"] { padding: 10px; border: 1px solid var(--accent); background: var(--bg-primary); color: var(--text-primary); border-radius: 4px; font-size: 14px; }
        .sensors { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .sensor { padding: 10px; border-radius: 4px; font-size: 14px; text-align: left; transition: background 0.3s; border: 1px solid #444; }
        .sensor.wet { background: rgba(0, 255, 65, 0.2); color: var(--success); border-color: var(--success); }
        .sensor.dry { background: rgba(255, 0, 85, 0.2); color: var(--danger); border-color: var(--danger); }
        .temp { text-align: center; font-size: 18px; margin-bottom: 15px; padding: 10px; background: var(--bg-primary); border-radius: 4px; }
        .timer-display { text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border-radius: 4px; color: #888; }
        .timer-display.running { color: var(--success); }
        .moisture-bar { width: 100%; height: 25px; background: var(--bg-primary); border-radius: 8px; overflow: hidden; margin-top: 8px; border: 1px solid #444; }
        .moisture-fill { height: 100%; background: linear-gradient(90deg, var(--danger), #ff6b00, var(--success)); transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 12px; font-weight: bold; color: #fff; }
        .log { background: var(--bg-primary); border: 1px solid var(--accent); border-radius: 4px; padding: 10px; font-size: 12px; max-height: 150px; overflow-y: auto; }
        .log-entry { padding: 5px; border-bottom: 1px solid #444; font-family: monospace; }
        .schedule-item { display: grid; grid-template-columns: 100px 1fr; gap: 10px; margin-bottom: 10px; align-items: center; }
        @keyframes pump-pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 65, 0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(0, 255, 65, 0.3); } }
        @media (max-width: 600px) { body { padding: 5px; } h1 { font-size: 24px; } .section { padding: 12px; } header { flex-direction: column; gap: 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <h1>üíß PUMP KONTROLL</h1>
                <div class="mode">üé≤ SIMULERING</div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
        </header>
        
        <div class="section">
            <div class="status-box stopped" id="statusBox">üî¥ STOPPAD</div>
        </div>
        
        <div class="section">
            <h2>üíß Pump Kontroll</h2>
            <div class="button-group">
                <button class="btn-start" onclick="startPump()">üü¢ STARTA</button>
                <button class="btn-stop" onclick="stopPump()">üî¥ STOPPA</button>
            </div>
            <button class="btn-auto" id="autoBtn" style="width: 100%; margin-top: 10px;" onclick="toggleAutoMode()">ü§ñ AUTO-MODE: AV</button>
        </div>
        
        <div class="section" id="autoSettings" style="display: none;">
            <h2>‚öôÔ∏è Auto-Mode</h2>
            <p style="font-size: 12px; margin-bottom: 10px;">Starta n√§r sensor < Min %, stoppa n√§r > Max %</p>
            <div id="autoLimits"></div>
        </div>
        
        <div class="section">
            <h2>‚è±Ô∏è Timer</h2>
            <div class="timer-display" id="timerDisplay">‚è±Ô∏è Timer: Inaktiv</div>
            <input type="number" id="timerSeconds" value="30" placeholder="Sekunder" min="1" style="width: 100%; margin-bottom: 10px;">
            <div class="button-group">
                <button class="btn-start" onclick="startTimer()">‚ñ∂Ô∏è STARTA</button>
                <button class="btn-stop" onclick="stopTimer()">‚èπÔ∏è STOPPA</button>
            </div>
        </div>
        
        <div class="section">
            <h2>üìÖ Tidschema</h2>
            <p style="font-size: 12px; margin-bottom: 10px;">Pumpen startar automatiskt p√• dessa tider</p>
            <div id="scheduleList"></div>
            <div style="display: grid; grid-template-columns: 1fr 60px; gap: 10px; margin-top: 10px;">
                <input type="time" id="scheduleTime" value="08:00">
                <button onclick="addSchedule()" style="background: var(--success); color: #000;">‚ûï</button>
            </div>
        </div>
        
        <div class="section">
            <h2>üìä Sensorer</h2>
            <div class="temp">üå°Ô∏è Temperatur: <span id="tempDisplay">--</span>¬∞C</div>
            <div class="sensors" id="sensorsList"></div>
        </div>
        
        <div class="section">
            <h2>üìã Aktivitetslogg</h2>
            <div class="log" id="logBox">
                <div class="log-entry" style="color: var(--accent);">Systemet startade...</div>
            </div>
            <button onclick="clearLog()" style="background: var(--danger); color: white; width: 100%; margin-top: 10px;">üóëÔ∏è RENSA</button>
        </div>
    </div>
    
    <script>
        let autoMode = false, logs = [], schedule = [];
        
        function loadSettings() {
            const saved = localStorage.getItem('pumpSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                autoMode = settings.autoMode || false;
                schedule = settings.schedule || [];
                for (let i = 0; i < 4; i++) {
                    const limit = document.getElementById(`sensor${i}-limit`);
                    if (limit && settings[`sensor${i}Limit`]) limit.value = settings[`sensor${i}Limit`];
                    const autoMin = document.getElementById(`sensor${i}-autoMin`);
                    const autoMax = document.getElementById(`sensor${i}-autoMax`);
                    if (autoMin && settings[`sensor${i}AutoMin`]) autoMin.value = settings[`sensor${i}AutoMin`];
                    if (autoMax && settings[`sensor${i}AutoMax`]) autoMax.value = settings[`sensor${i}AutoMax`];
                }
                updateAutoModeButton();
            }
            renderSchedule();
        }
        
        function saveSettings() {
            const settings = { autoMode, schedule };
            for (let i = 0; i < 4; i++) {
                const limit = document.getElementById(`sensor${i}-limit`);
                const autoMin = document.getElementById(`sensor${i}-autoMin`);
                const autoMax = document.getElementById(`sensor${i}-autoMax`);
                if (limit) settings[`sensor${i}Limit`] = parseInt(limit.value);
                if (autoMin) settings[`sensor${i}AutoMin`] = parseInt(autoMin.value);
                if (autoMax) settings[`sensor${i}AutoMax`] = parseInt(autoMax.value);
            }
            localStorage.setItem('pumpSettings', JSON.stringify(settings));
        }
        
        function loadTheme() {
            if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        }
        
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }
        
        function createSensorHTML(index) {
            return `<div class="sensor" id="sensor${index}"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><div>üíß Sensor ${index + 1}: <span id="sensor${index}-text">--%</span></div><div style="font-size: 12px;">Gr√§ns: <input type="number" id="sensor${index}-limit" value="60" min="0" max="100" style="width: 40px; padding: 4px;" onchange="saveSettings()">%</div></div><div class="moisture-bar"><div class="moisture-fill" id="sensor${index}-fill" style="width: 0%">0%</div></div></div>`;
        }
        
        function createAutoSettingsHTML() {
            let html = '';
            for (let i = 0; i < 4; i++) html += `<div style="background: var(--bg-primary); padding: 10px; border-radius: 4px; margin-bottom: 10px;"><p style="font-size: 12px; margin-bottom: 5px;">üíß Sensor ${i + 1}</p><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;"><input type="number" id="sensor${i}-autoMin" value="40" min="0" max="100" placeholder="Min %" onchange="saveSettings()"><input type="number" id="sensor${i}-autoMax" value="70" min="0" max="100" placeholder="Max %" onchange="saveSettings()"></div></div>`;
            return html;
        }
        
        function renderSensors() {
            let html = '';
            for (let i = 0; i < 4; i++) html += createSensorHTML(i);
            document.getElementById('sensorsList').innerHTML = html;
        }
        
        function toggleAutoMode() {
            autoMode = !autoMode;
            updateAutoModeButton();
            document.getElementById('autoSettings').style.display = autoMode ? 'block' : 'none';
            saveSettings();
            addLog(autoMode ? 'ü§ñ Auto-mode aktiverad' : 'ü§ñ Auto-mode inaktiverad');
        }
        
        function updateAutoModeButton() {
            const btn = document.getElementById('autoBtn');
            btn.classList.toggle('active', autoMode);
            btn.textContent = autoMode ? 'ü§ñ AUTO-MODE: P√Ö' : 'ü§ñ AUTO-MODE: AV';
        }
        
        function addLog(message) {
            const time = new Date().toLocaleTimeString('sv-SE');
            logs.push(`${time} - ${message}`);
            document.getElementById('logBox').innerHTML = logs.slice(-10).map(log => `<div class="log-entry">${log}</div>`).join('');
        }
        
        function clearLog() {
            logs = [];
            document.getElementById('logBox').innerHTML = '<div class="log-entry" style="color: var(--accent);">Logg rensad</div>';
        }
        
        function addSchedule() {
            const time = document.getElementById('scheduleTime').value;
            if (time && !schedule.includes(time)) {
                schedule.push(time);
                schedule.sort();
                saveSettings();
                renderSchedule();
                addLog(`üìÖ Schema tillagt: ${time}`);
            }
        }
        
        function renderSchedule() {
            const scheduleList = document.getElementById('scheduleList');
            if (schedule.length === 0) {
                scheduleList.innerHTML = '<p style="font-size: 12px; color: #888;">Ingen schemal√§ggning</p>';
            } else {
                scheduleList.innerHTML = schedule.map(time => `<div class="schedule-item"><span style="font-weight: bold;">${time}</span><button onclick="removeSchedule('${time}')" style="background: var(--danger); width: 100%; padding: 6px;">‚ùå</button></div>`).join('');
            }
        }
        
        function removeSchedule(time) {
            schedule = schedule.filter(t => t !== time);
            saveSettings();
            renderSchedule();
            addLog(`üìÖ Schema borttagen: ${time}`);
        }
        
        async function startPump() {
            await fetch('/api/pump/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ speed: 100 }) });
            addLog('üü¢ Pumpen startad');
            updateStatus();
        }
        
        async function stopPump() {
            await fetch('/api/pump/stop', { method: 'POST' });
            addLog('üî¥ Pumpen stoppad');
            updateStatus();
        }
        
        async function startTimer() {
            const seconds = document.getElementById('timerSeconds').value;
            await fetch('/api/timer/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ seconds: parseInt(seconds), speed: 100 }) });
            addLog(`‚è±Ô∏è Timer startad: ${seconds}s`);
            updateStatus();
        }
        
        async function stopTimer() {
            await fetch('/api/timer/stop', { method: 'POST' });
            addLog('‚èπÔ∏è Timer stoppad');
            updateStatus();
        }
        
        async function updateStatus() {
            const response = await fetch('/api/status');
            const data = await response.json();
            
            const statusBox = document.getElementById('statusBox');
            if (data.pump_running) {
                statusBox.textContent = 'üü¢ K√ñRS';
                statusBox.className = 'status-box running';
            } else {
                statusBox.textContent = 'üî¥ STOPPAD';
                statusBox.className = 'status-box stopped';
            }
            
            let lowestMoisture = 100;
            data.moisture.forEach((moisture) => { lowestMoisture = Math.min(lowestMoisture, moisture); });
            if (lowestMoisture < 30) {
                statusBox.classList.add('warning');
                statusBox.textContent = '‚ö†Ô∏è EN SENSOR MYCKET TORR!';
            }
            
            const timerDisplay = document.getElementById('timerDisplay');
            if (data.timer_running) {
                timerDisplay.textContent = `‚è±Ô∏è Timer: ${data.timer_remaining}s`;
                timerDisplay.className = 'timer-display running';
            } else {
                timerDisplay.textContent = '‚è±Ô∏è Timer: Inaktiv';
                timerDisplay.className = 'timer-display';
            }
            
            document.getElementById('tempDisplay').textContent = data.temperature;
            
            data.moisture.forEach((moisture, index) => {
                const sensorEl = document.getElementById(`sensor${index}`);
                const textEl = document.getElementById(`sensor${index}-text`);
                const fill = document.getElementById(`sensor${index}-fill`);
                const limitInput = document.getElementById(`sensor${index}-limit`);
                const limit = parseInt(limitInput.value) || 60;
                
                textEl.textContent = `${moisture}%`;
                fill.style.width = `${moisture}%`;
                fill.textContent = `${moisture}%`;
                sensorEl.className = moisture >= limit ? 'sensor wet' : 'sensor dry';
            });
            
            if (autoMode && !data.pump_running) {
                for (let i = 0; i < 4; i++) {
                    const autoMin = parseInt(document.getElementById(`sensor${i}-autoMin`)?.value || 40);
                    if (data.moisture[i] < autoMin) {
                        startPump();
                        addLog(`ü§ñ Auto: Pumpen startad (Sensor ${i + 1} < ${autoMin}%)`);
                        break;
                    }
                }
            } else if (autoMode && data.pump_running) {
                let shouldStop = true;
                for (let i = 0; i < 4; i++) {
                    const autoMax = parseInt(document.getElementById(`sensor${i}-autoMax`)?.value || 70);
                    if (data.moisture[i] < autoMax) {
                        shouldStop = false;
                        break;
                    }
                }
                if (shouldStop) {
                    stopPump();
                    addLog('ü§ñ Auto: Pumpen stoppad (alla sensorer > Max%)');
                }
            }
            
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            if (schedule.includes(currentTime) && !data.pump_running) {
                startPump();
                addLog(`üìÖ Schemal√§ggd k√∂rning: ${currentTime}`);
            }
        }
        
        loadTheme();
        renderSensors();
        loadSettings();
        document.getElementById('autoLimits').innerHTML = createAutoSettingsHTML();
        setInterval(updateStatus, 1000);
        updateStatus();
    </script>
</body>
</html>
